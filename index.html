<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Monte Carlo Bet Manager</title>
<meta name="color-scheme" content="light dark">

<style>
  /* ---------- Theme & Reset ---------- */
  :root{
    --bg: #0e1116; --surface: #151a22; --muted:#9aa3b2; --text:#eef1f6;
    --primary:#67b1ff; --ok:#5ad19a; --danger:#ff6b81; --border:#232a36;
    --chip:#0f141c; --shadow: 0 10px 30px rgba(0,0,0,.35);
  }
  @media (prefers-color-scheme: light){
    :root{
      --bg:#f6f7fb; --surface:#ffffff; --muted:#556070; --text:#0e1116;
      --primary:#2563eb; --ok:#16a34a; --danger:#dc2626; --border:#e5e7eb; --chip:#f2f4f7;
    }
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:
      radial-gradient(1000px 500px at 10% -10%, rgba(103,177,255,.12), transparent 60%),
      radial-gradient(800px 400px at 110% 10%, rgba(90,209,133,.10), transparent 55%),
      var(--bg);
    color:var(--text);
    font:16px/1.6 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Noto Sans JP, sans-serif;
  }
  a{color:inherit}

  /* ---------- Layout ---------- */
  .wrap{max-width:980px;margin:0 auto;padding:24px 16px 110px}
  header{
    position:sticky; top:0; z-index:5; backdrop-filter:saturate(1.2) blur(10px);
    background:color-mix(in oklab, var(--bg) 78%, transparent);
    border-bottom:1px solid var(--border);
  }
  .h-inner{max-width:980px;margin:0 auto;padding:12px 16px; display:flex; gap:12px; align-items:center; justify-content:space-between}
  .brand{display:flex; align-items:center; gap:12px}
  .logo{
    width:34px;height:34px;border-radius:10px; display:grid;place-items:center;
    background: linear-gradient(150deg, color-mix(in oklab, var(--primary) 85%, #fff 0%), color-mix(in oklab, var(--ok) 85%, #fff 0%));
    box-shadow: var(--shadow);
    color:#fff; font-weight:800;
  }
  .title{font-weight:800; letter-spacing:.2px}
  .muted{color:var(--muted)}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}

  /* ---------- Cards ---------- */
  .card{
    background:var(--surface); border:1px solid var(--border);
    border-radius:16px; padding:16px 18px; box-shadow: var(--shadow);
  }
  .grid{
    display:grid; gap:12px;
    grid-template-columns: 1.2fr 1fr;
  }
  @media (max-width:860px){ .grid{grid-template-columns: 1fr} }

  /* ---------- Inputs / Pills ---------- */
  label{font-size:13px; color:var(--muted)}
  input[type="number"]{
    width:260px; max-width:100%;
    background:var(--chip); color:var(--text);
    border:1px solid var(--border); border-radius:12px; padding:12px 14px; font-size:18px;
    outline:none;
  }
  .pill{
    display:inline-flex; align-items:baseline; gap:8px;
    border:1px solid var(--border); background:var(--chip);
    border-radius:999px; padding:8px 12px; margin:6px 8px 0 0; font-variant-numeric:tabular-nums;
  }
  .seq{font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace}

  /* ---------- Bet Gauge ---------- */
  .gauge{
    display:flex; align-items:center; gap:14px; margin-top:6px
  }
  .meter{
    flex:1; height:14px; border-radius:999px; overflow:hidden; border:1px solid var(--border); background:var(--chip);
  }
  .bar{height:100%; width:0%; background: linear-gradient(90deg, var(--primary), var(--ok)); transition:width .35s ease}
  .betnum{font-size:28px; font-weight:800}

  /* ---------- Buttons ---------- */
  .fab{
    position:fixed; inset:auto 16px 16px 16px; display:flex; gap:10px; z-index:6;
    background:color-mix(in oklab, var(--surface) 92%, transparent); border:1px solid var(--border);
    border-radius:14px; padding:10px; box-shadow: var(--shadow);
  }
  .btn{
    cursor:pointer; border:0; border-radius:12px; padding:14px 16px; font-weight:800; font-size:18px; min-width:120px;
    transition: transform .04s ease, opacity .2s ease;
  }
  .btn:disabled{opacity:.5; cursor:not-allowed}
  .btn:active{transform:translateY(1px)}
  .btn-win{background:var(--ok); color:#0a0f0d}
  .btn-lose{background:var(--danger); color:#fff}
  .btn-reset{background:var(--chip); color:var(--text); border:1px solid var(--border)}

  /* ---------- Table ---------- */
  table{width:100%; border-collapse:collapse; margin-top:10px}
  th, td{padding:10px 8px; border-bottom:1px solid var(--border); text-align:right; font-variant-numeric:tabular-nums}
  th{color:var(--muted); font-weight:700}
  td:first-child, th:first-child{ text-align:left }
  td:last-child, th:last-child{ text-align:left }
  tbody tr{ transition: background .2s ease }
  tbody tr.win{ background: color-mix(in oklab, var(--ok) 20%, transparent) }
  tbody tr.lose{ background: color-mix(in oklab, var(--danger) 15%, transparent) }

  /* ---------- Badges ---------- */
  .chips{display:flex; flex-wrap:wrap; gap:8px}
  .chip{
    background:var(--chip); border:1px solid var(--border); border-radius:11px; padding:6px 10px; display:inline-flex; gap:6px;
  }
  .chip strong{font-variant-numeric:tabular-nums}

  /* ---------- Theme Toggle ---------- */
  .toggle{
    display:inline-flex; align-items:center; gap:8px; border:1px solid var(--border); background:var(--chip);
    padding:8px 10px; border-radius:12px; cursor:pointer; user-select:none;
  }

  /* fancy highlight when bet changes */
  .flash{animation:flash .5s}
  @keyframes flash{
    from{box-shadow: 0 0 0 0 rgba(103,177,255,.5)}
    to{box-shadow: 0 0 0 18px rgba(103,177,255,0)}
  }
</style>
</head>
<body>
  <!-- Header -->
  <header>
    <div class="h-inner">
      <div class="brand">
        <div class="logo">MC</div>
        <div>
          <div class="title">Monte Carlo Bet Manager</div>
          <div class="muted" style="font-size:12px">勝ち=両端削除 / 負け=右端にベット額追加 / [1] or 空ならサイクル+1 → リセット</div>
        </div>
      </div>
      <div class="toggle" id="themeToggle" title="テーマ切替">
        <span>Theme</span><input id="themeChk" type="checkbox" />
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="wrap">
    <section class="grid">
      <!-- Left: Controls -->
      <div class="card">
        <div class="row">
          <div>
            <label>初期損切り（1ユニットの金額）</label><br>
            <input id="unitInput" type="number" min="0" step="1" placeholder="50000" inputmode="numeric">
          </div>
          <div>
            <span class="pill">現在の数列： <span id="seq" class="seq"></span></span>
            <span class="pill">次のベット（ユニット）：<span id="betUnits" class="betnum">1</span></span>
            <span class="pill">次のベット（円）：<span id="betMoney" class="betnum">0</span></span>
          </div>
        </div>

        <div class="gauge">
          <div class="meter"><div id="bar" class="bar"></div></div>
          <div class="muted" style="min-width:90px;text-align:right">負荷メータ</div>
        </div>
      </div>

      <!-- Right: Stats -->
      <div class="card">
        <div class="chips">
          <div class="chip">累計サイクル勝ち：<strong id="cycles">0</strong></div>
          <div class="chip">実現損益（ユニット）：<strong id="pnlUnits">0</strong></div>
          <div class="chip">実現損益（円）：<strong id="pnlMoney">0</strong></div>
        </div>
        <div class="muted" style="margin-top:8px;font-size:12px">
          ベット額＝左端＋右端。単一で2以上なら ⌊n/2⌋ と ⌈n/2⌉ に分解。<br>
          状態は自動保存（localStorage）。ボタンは下のバーから操作してね。
        </div>
      </div>
    </section>

    <!-- Log -->
    <section class="card" style="margin-top:16px">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:12px">
        <h3 style="margin:0">履歴</h3>
        <button id="resetBtn" class="btn btn-reset">リセット</button>
      </div>
      <table id="logTable">
        <thead>
          <tr>
            <th style="text-align:left">ステップ</th>
            <th style="text-align:left">結果</th>
            <th>ベット(ユニット)</th>
            <th>損益(ユニット)</th>
            <th>損益(円)</th>
            <th style="text-align:left">数列の状態</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <!-- Floating Action Bar -->
  <div class="fab">
    <button id="winBtn"  class="btn btn-win">勝ち</button>
    <button id="loseBtn" class="btn btn-lose">負け</button>
  </div>

<script>
/* ===================== Core State ===================== */
const seqEl = document.getElementById('seq');
const betUnitsEl = document.getElementById('betUnits');
const betMoneyEl = document.getElementById('betMoney');
const unitInput = document.getElementById('unitInput');
const winBtn = document.getElementById('winBtn');
const loseBtn = document.getElementById('loseBtn');
const resetBtn = document.getElementById('resetBtn');
const logBody = document.querySelector('#logTable tbody');
const cyclesEl = document.getElementById('cycles');
const pnlUnitsEl = document.getElementById('pnlUnits');
const pnlMoneyEl = document.getElementById('pnlMoney');
const bar = document.getElementById('bar');
const themeCHK = document.getElementById('themeChk');

const store = {
  get(){ try{ return JSON.parse(localStorage.getItem('mc_state_pretty')||'{}'); }catch(e){ return {}; } },
  set(v){ localStorage.setItem('mc_state_pretty', JSON.stringify(v)); }
};
const storeTheme = {
  get(){ return localStorage.getItem('mc_theme')||''; },
  set(v){ localStorage.setItem('mc_theme', v); }
};

let seq = [0,1];
let step = 0;
let cycles = 0;
let pnlUnits = 0;

function yen(n){ return Number(n||0).toLocaleString('ja-JP'); }
function showSeq(){ seqEl.textContent = `[${seq.join(', ')}]`; }

function nextBetUnits(){
  if (seq.length === 0) return 0;
  if (seq.length === 1) {
    if (seq[0] === 1) return 0;
    const a = Math.floor(seq[0]/2), b = Math.ceil(seq[0]/2);
    return a + b; // 元の値
  }
  return seq[0] + seq[seq.length-1];
}

function updateGauge(units){
  // 見た目の目安ゲージ：配列の合計をざっくり上限にして割合化
  const sum = seq.reduce((a,b)=>a+b,0) || 1;
  const pct = Math.min(100, Math.round( (units/sum) * 100 ));
  bar.style.width = pct + '%';
}

function updateUI(flash=false){
  showSeq();
  const units = nextBetUnits();
  betUnitsEl.textContent = units;
  const unitMoney = Number(unitInput.value || 0);
  betMoneyEl.textContent = yen(units * unitMoney);
  cyclesEl.textContent = cycles;
  pnlUnitsEl.textContent = pnlUnits;
  pnlMoneyEl.textContent = yen(pnlUnits * unitMoney);
  winBtn.disabled = units === 0;
  loseBtn.disabled = units === 0;
  updateGauge(units);

  if (flash) {
    betUnitsEl.classList.remove('flash'); void betUnitsEl.offsetWidth; betUnitsEl.classList.add('flash');
    betMoneyEl.classList.remove('flash'); void betMoneyEl.offsetWidth; betMoneyEl.classList.add('flash');
  }

  // persist
  store.set({seq, step, cycles, pnlUnits, unitMoney});
}

function pushLog(result, betU){
  const unitMoney = Number(unitInput.value || 0);
  const tr = document.createElement('tr');
  tr.className = result.toLowerCase() === 'win' ? 'win' : 'lose';
  tr.innerHTML = `
    <td style="text-align:left">${++step}</td>
    <td style="text-align:left">${result}</td>
    <td>${betU}</td>
    <td>${result === 'Win' ? '+'+betU : '-'+betU}</td>
    <td>${result === 'Win' ? '+' : '-'}${yen(betU * unitMoney)}</td>
    <td style="text-align:left" class="seq">[${seq.join(', ')}]</td>
  `;
  logBody.prepend(tr);
}

function endCycle(){
  cycles += 1;
  seq = [0,1];
}

function onWin(){
  const betU = nextBetUnits();
  if (betU === 0) return;
  pnlUnits += betU;

  if (seq.length >= 2) {
    seq.shift(); seq.pop();
  }

  if (seq.length === 0) {
    pushLog('Win', betU);
    endCycle();
  } else if (seq.length === 1) {
    if (seq[0] === 1) {
      pushLog('Win', betU);
      endCycle();
    } else {
      const n = seq[0];
      seq = [Math.floor(n/2), Math.ceil(n/2)];
      pushLog('Win', betU);
    }
  } else {
    pushLog('Win', betU);
  }
  updateUI(true);
}

function onLose(){
  const betU = nextBetUnits();
  if (betU === 0) return;
  pnlUnits -= betU;
  seq.push(betU);
  pushLog('Lose', betU);
  updateUI(true);
}

function resetAll(){
  if (!confirm('履歴と集計を全てリセットしますか？')) return;
  seq = [0,1]; step = 0; cycles = 0; pnlUnits = 0;
  logBody.innerHTML = '';
  updateUI(true);
}

/* ===================== Theme ===================== */
function applyTheme(){
  const pref = storeTheme.get();
  const light = pref === 'light' || (pref==='' && window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches);
  document.documentElement.style.colorScheme = light ? 'light' : 'dark';
  themeCHK.checked = light;
}
document.getElementById('themeToggle').addEventListener('click', ()=>{
  const next = themeCHK.checked ? 'dark' : 'light';
  storeTheme.set(next);
  applyTheme();
});

/* ===================== Init ===================== */
winBtn.addEventListener('click', onWin);
loseBtn.addEventListener('click', onLose);
resetBtn.addEventListener('click', resetAll);
unitInput.addEventListener('input', ()=>updateUI(true));

// Restore state
const s = store.get();
if (s.unitMoney != null) unitInput.value = s.unitMoney;
if (Array.isArray(s.seq) && s.seq.length) seq = s.seq;
if (typeof s.step === 'number') step = s.step;
if (typeof s.cycles === 'number') cycles = s.cycles;
if (typeof s.pnlUnits === 'number') pnlUnits = s.pnlUnits;
applyTheme();
updateUI();
</script>
</body>
</html>
